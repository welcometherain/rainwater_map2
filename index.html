<!DOCTYPE html>
<html>
  <head>
    <title>Rainwater Harvesting Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #totals {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        font-family: sans-serif;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <div id="totals"><strong>Rainfall Totals</strong><div id="results"></div></div>
    <div id="map"></div>

    <script>
      let map;
      let drawingManager;
      const polygons = [];
      const RAINFALL_INCHES = 1;
      const SQFT_PER_ACRE_IN_INCHES = 0.623;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 32.7157, lng: -117.1611 }, // San Diego
          zoom: 16,
          mapTypeId: 'hybrid',
          tilt: 0
        });

        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.POLYGON,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: [google.maps.drawing.OverlayType.POLYGON]
          },
          polygonOptions: {
            editable: true,
            fillColor: '#33AAFF',
            fillOpacity: 0.5,
            strokeWeight: 2,
            clickable: true,
            zIndex: 1
          }
        });
        drawingManager.setMap(map);

        google.maps.event.addListener(drawingManager, "overlaycomplete", async function (event) {
          if (event.type === "polygon") {
            const label = prompt("Label this polygon (e.g., Roof, Driveway):", "Unnamed Area") || "Unnamed Area";

            const colorOptions = ["#33AAFF", "#55CC55", "#FF9933", "#AA66CC", "#996633"];
            const color = await promptColor(colorOptions) || "#33AAFF";

            const polygon = event.overlay;
            polygon.setOptions({ fillColor: color, strokeColor: color });
            polygon.setEditable(true);

            const polyData = { label, color, polygon };
            polygons.push(polyData);

            polygon.addListener("rightclick", () => {
              if (confirm(`Delete polygon '${label}'?`)) {
                polygon.setMap(null);
                const index = polygons.indexOf(polyData);
                if (index > -1) polygons.splice(index, 1);
                updateResults();
              }
            });

            polygon.addListener("click", () => {
              const newLabel = prompt("Rename this area:", polyData.label);
              if (newLabel) {
                polyData.label = newLabel;
                updateResults();
              }
            });

            polygon.getPath().addListener("set_at", updateResults);
            polygon.getPath().addListener("insert_at", updateResults);
            updateResults();
          }
        });
      }

      function computeArea(polygon) {
        return google.maps.geometry.spherical.computeArea(polygon.getPath());
      }

      function updateResults() {
        const container = document.getElementById("results");
        container.innerHTML = "";
        polygons.forEach(({ label, polygon }) => {
          const areaSqMeters = computeArea(polygon);
          const areaSqFeet = areaSqMeters * 10.7639;
          const gallons = areaSqFeet * SQFT_PER_ACRE_IN_INCHES * RAINFALL_INCHES;
          const areaRounded = Math.round(areaSqFeet).toLocaleString();
          const gallonsRounded = Math.round(gallons).toLocaleString();
          const div = document.createElement("div");
          div.innerHTML = `<strong>${label}</strong>: ${areaRounded} sq ft = ${gallonsRounded} gallons`;
          container.appendChild(div);
        });
      }

      function promptColor(colors) {
        const colorHTML = colors.map(c => `<span class="color-swatch" data-color="${c}" style="background-color:${c}"></span>`).join('');
        const colorDiv = document.createElement("div");
        colorDiv.innerHTML = `
          <div style="padding:10px;font-family:sans-serif">
            <strong>Select a color:</strong><br>
            ${colorHTML}
          </div>
        `;
        Object.assign(colorDiv.style, {
          position: 'fixed',
          top: '100px',
          left: '50%',
          transform: 'translateX(-50%)',
          background: '#fff',
          border: '1px solid #ccc',
          borderRadius: '8px',
          boxShadow: '0 2px 10px rgba(0,0,0,0.1)',
          zIndex: 1000
        });

        document.body.appendChild(colorDiv);

        return new Promise(resolve => {
          colorDiv.querySelectorAll(".color-swatch").forEach(el => {
            el.style.display = "inline-block";
            el.style.width = "30px";
            el.style.height = "30px";
            el.style.margin = "5px";
            el.style.cursor = "pointer";
            el.style.borderRadius = "6px";
            el.addEventListener("click", () => {
              const selected = el.getAttribute("data-color");
              document.body.removeChild(colorDiv);
              resolve(selected);
            });
          });
        });
      }
    </script>

    <!-- Load Google Maps API -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuFONHLyXGalqEH9VL3oFl8MpHgF7sa5k&libraries=places,drawing,geometry&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>

