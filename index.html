<!DOCTYPE html>
<html>
  <head>
    <title>Rainwater Harvesting Calculator</title>
    <meta charset="utf-8" />
    <style>
      html, body {
        height: 100%;
        margin: 0;
        font-family: 'Quattrocento Sans', sans-serif;
      }

      #map {
        height: 80%;
        width: 100%;
      }

      #controls {
        padding: 20px;
        background-color: #34495e;
        color: white;
      }

      #controls h2 {
        margin-top: 0;
        font-size: 24px;
      }

      #controls ol {
        padding-left: 20px;
      }

      #controls li {
        margin-bottom: 10px;
      }

      #inputs {
        padding: 15px;
        background-color: #f2f2f2;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      label {
        margin-right: 10px;
      }

      #results {
        padding: 15px;
        background-color: #ffffff;
        font-size: 16px;
      }

      input[type="text"], input[type="number"] {
        padding: 6px;
        font-size: 16px;
      }

      button {
        background-color: #EC1E7D;
        color: white;
        border: none;
        padding: 8px 16px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
      }

      button:hover {
        background-color: #d0186e;
      }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Quattrocento+Sans&display=swap" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuFONHLyXGalqEH9VL3oFl8MpHgF7sa5k&libraries=places,drawing&callback=initMap" async defer></script>
  </head>
  <body>
    <div id="controls">
      <h2>How to Use This Tool</h2>
      <ol>
        <li>Find your property using the address search box or scroll to your location on the map.</li>
        <li>Draw polygons on the map to represent areas that you would like to calculate rainfall runoff (This can be a house, driveway, or the land itself).</li>
        <li>Label each polygon with a description (e.g., 'Roof', 'Driveway').</li>
        <li>Edit polygon shape or name by using the <span style="font-weight:bold;">üñêÔ∏è</span> tool and clicking on the polygon.</li>
        <li>Enter annual rainfall in inches to calculate rainwater potential for each area drawn.</li>
      </ol>
    </div>

    <div id="inputs">
      <label for="address">Address:</label>
      <input id="address" type="text" placeholder="Enter address" />
      <label for="rainfall">Annual Rainfall (inches):</label>
      <input id="rainfall" type="number" placeholder="e.g. 15" />
      <button onclick="calculateRainwater()">Calculate</button>
    </div>

    <div id="map"></div>
    <div id="results"></div>

    <script>
      let map;
      let drawingManager;
      let polygons = [];
      let infoWindow;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 34.05, lng: -118.25 }, // Southern California
          zoom: 8,
          mapTypeId: 'hybrid',
          tilt: 0,
          gestureHandling: "greedy"
        });

        infoWindow = new google.maps.InfoWindow();

        // Autocomplete
        const input = document.getElementById("address");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.bindTo("bounds", map);
        autocomplete.setFields(["geometry"]);

        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (!place.geometry || !place.geometry.location) return;
          map.panTo(place.geometry.location);
          map.setZoom(16);
        });

        // Drawing manager
        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.POLYGON,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ["polygon"],
          },
          polygonOptions: {
            editable: true,
            fillColor: "#007BFF",
            fillOpacity: 0.5,
            strokeColor: "#007BFF",
            strokeWeight: 2,
          },
        });

        drawingManager.setMap(map);

        google.maps.event.addListener(drawingManager, "overlaycomplete", function (event) {
          if (event.type === "polygon") {
            const polygon = event.overlay;
            polygon.setEditable(true);
            promptPolygonLabel(polygon);
          }
        });
      }

      function promptPolygonLabel(polygon) {
        const label = prompt("Enter a name for this area:");
        polygon.customLabel = label || "Unnamed Area";
        polygons.push(polygon);
      }

      function calculateRainwater() {
        const rainfall = parseFloat(document.getElementById("rainfall").value);
        if (isNaN(rainfall)) {
          alert("Please enter a valid rainfall amount.");
          return;
        }

        let resultsHTML = `<h3>Rainwater Potential</h3><ul>`;
        polygons.forEach((polygon, index) => {
          const areaMeters = google.maps.geometry.spherical.computeArea(polygon.getPath());
          const areaFeet = areaMeters * 10.7639;
          const gallons = areaFeet * (rainfall / 12) * 0.623;
          resultsHTML += `<li><strong>${polygon.customLabel}</strong>: ${Math.round(areaFeet).toLocaleString()} sq ft can collect ${Math.round(gallons).toLocaleString()} gallons/year</li>`;
        });
        resultsHTML += `</ul>`;
        document.getElementById("results").innerHTML = resultsHTML;
      }
    </script>
  </body>
</html>
